<template id="sdtemplate">
<svg class="clip-svg">
      <defs>
        <clipPath id="clipBefore" clipPathUnits="objectBoundingBox">
            <polygon points="0 0, 1 0, 1 1" />
        </clipPath>
      </defs>  
  </svg>
  <svg class="clip-svg">
      <defs>
        <clipPath id="clipAfter" clipPathUnits="objectBoundingBox">
            <polygon points="0.06 0.01, 0 0.5, 1 0" />
        </clipPath>
      </defs>  
  </svg>
  <svg class="clip-svg">
      <defs>
        <clipPath id="clipHair" clipPathUnits="objectBoundingBox">
            <polygon points="0 0, 0.8 1, 0.8 0" />
        </clipPath>
      </defs>  
  </svg>
<style id="menu">
    svg{
      width: 0;
      height: 0;
    }
    .icons{
        width: 150px;
        height: 150px;
        display: inline-block;
        position: relative;
        padding-right: 2%;
        float: left;
    }
    .base{
        position: relative;
        width: 150px;
        height: 150px;
        background: #80B88C;
        border-radius: 50%;
        overflow: hidden;
        float: left;
    }
    .base:before{
        content: "";
        position: absolute;
        top: 10px;
        left: 35px;
        width: 80px;
        height: 90px;
        background: rgb(255, 201, 177);
        border-radius: 30px;
        z-index: 1;
    }
    .chrome .base:after{
            content: "";
            position: absolute;
            background: #A0DBDF;
            top: 100px;
            left: 40px;
            width: 70px;
            height: 50px;
            border-radius: 15px;
            z-index: 1;
        }
     .chrome .hair:before{
          content: "";
          position: absolute;
          top: 20px;
          left: 8px;
          height: 100px;
          background: rgb(51,49,49);
          -webkit-clip-path: polygon(6% 1%, 0% 50%, 100% 0%);
          clip-path: polygon(6% 1%, 0% 50%, 100% 0%);
          z-index: 1;
      }
      .chrome .hair:after{
          content: "";
          position: absolute;
          top: 20px;
          left: 70px;
          width: 26px;
          height: 49px;
          background: rgb(51,49,49);
          -webkit-clip-path: polygon(0 0, 80% 100%, 80% 0%);
          clip-path: polygon(0 0, 80% 100%, 80% 0%);
          z-index: 1;
    }
    .hair{
        position: absolute;
        width: 100px;
        height: 150px;
        background: rgb(51,49,49);
        top: -11px;
        left: 25px;
        border-radius: 45px;
    }
    .length-short{
        height: 120px;
    }
    .length-long{
        height: 150px;
    }
    .bang-left:before, .bang-left .left{
        width: 65px;
    }
    .chrome .bang-right:after, .bang-right .right{
        top: 19px;
        left: 16px;
        width: 76px;
        height: 42px;
        -webkit-clip-path: polygon(0 0, 100% 0%, 100% 100%);
        clip-path: polygon(0 0, 100% 0%, 100% 100%);
    }
    .bang-none:before, .bang-right:before{
        width: 25px;
    }
    .sense{
        position: relative;
        width: 15px;
        height: 25px;
        background: rgb(51,49,49);
        top: 49px;
        left: 48px;
        border-radius: 5px;
        z-index: 1;
        box-shadow: 40px 0 rgb(51,49,49);
    }
    .sense:before{
        content: "";
        position: absolute;
        width: 10px;
        height: 20px;
        background: rgb(255, 201, 177);
        right: 23px;
        top: 8px;
        border-radius: 5px;
        box-shadow: 80px 0 rgb(255, 201, 177);
    }
    .sense:after{
        content: "";
        position: absolute;
        border-radius: 0 0 30px 33px;
        background: #fff;
    }
    .eyes-pos-down{
        bottom: 105px;
    }
    .eyes-pos-left:after{
        left: 17px;
    }
    .mouth-joy:after{
        width: 15px;
        height: 15px;
        top: 30px;
        left: 20px;
    }
    .sense.mouth-shy:after{
        width: 5px;
        height: 10px;
        top: 30px;
        left: 24px;
    }
    .accessory.glass{
        width: 24px;
        height: 28px;
        border-radius: 3px;
        top: 46px;
        position: absolute;
        left: 43px;
        z-index: 1;
        background: rgba(124, 125, 124, 0.44);
        box-shadow: 40px 0 rgba(124, 125, 124, 0.44);
    }
    .accessory.earrings{
        width: 5px;
        height: 5px;
        background: #fff;
        position: absolute;
        left: 30px;
        top: 70px;
        z-index: 1;
        box-shadow: 84px 0 #fff;
    }
    .glass:before{
        content: "";
        width: 10px;
        border: 1px solid rgba(124, 125, 124, 0.44);
        position: absolute;
        right: 24px;
        bottom: 19px;
        box-shadow: 38px 3px rgba(124, 125, 124, 0.44), 76px 0 rgba(124, 125, 124, 0.44);
    }
    .eyes-small{
        width: 10px;
        height: 15px;
        bottom: 100px;
        left: 50px;
        box-shadow: 42px 0 rgb(51,49,49);
        bottom: 75px;
    }
    .eyes-small:after{
        left: 19px;
    }
    .eyes-small:before{
        box-shadow: 84px 0 rgb(255, 201, 177);
    }
    .left{
        position: absolute;
        top: 20px;
        left: 8px;
        width: 26px;
        height: 100px;
        background: rgb(51,49,49);
        -webkit-clip-path: polygon(0 0, 80% 100%, 80% 0%);
          clip-path: polygon(0 0, 80% 100%, 80% 0%);
        clip-path: url(#clipAfter);
        z-index: 1;
      }
     .right{
          position: absolute;
          top: 20px;
          left: 70px;
          width: 26px;
          height: 49px;
          background: rgb(51,49,49);
          -webkit-clip-path: polygon(0 0, 80% 100%, 80% 0%);
          clip-path: polygon(0 0, 80% 100%, 80% 0%);
          clip-path: url(#clipHair);
          z-index: 1;
      }
    .cloth{
        position: absolute;
        background: #A0DBDF;
        top: 100px;
        left: 40px;
        width: 70px;
        height: 50px;
        border-radius: 15px;
        z-index: 1;
      }
    }
  </style>
</template>
<script>
    var MYAPP = {};
    /**
     * @namespace MYAPP
     * @Object TasksObj
     * @constructor
     */
    MYAPP.TasksObj = function(chrome, doc, tasks, t, el, container, bgColor, hairColor, eyesColor, clothColor){
        /**
         * @property doc
         * @type Element
         */
        this.doc = doc;
        /**
         * @property tasks
         * @type Array
         */
        this.tasks = tasks;
        /**
         * @property t
         * @type Element
         */
        this.t = t;
        /**
         * @property el
         * @type Element
         */
        this.el = el;
        /**
         * @property root
         * @type Element
         */
        this.root = el.createShadowRoot();
        /**
         * @property container
         * @type boolean
         */
        this.container = container;
        this.bg = bgColor;
        this.hair = hairColor;
        this.eyes = eyesColor;
        this.cloth = clothColor;
        this.chrome = chrome;
    }
    /**
     * @method setT
     * Remove duplicate childNode
     */
    MYAPP.TasksObj.prototype.setT = function(){
        if(this.t.content && this.t.content.childNodes.length > 3){
            var len = this.t.content.childNodes.length;
                this.t.content.childNodes[len-1].remove();
        }
    }
    /**
     * @method createFragment
     * @return {Element}
     * Generate content includes all needed className 
     */
    MYAPP.TasksObj.prototype.createFragment = function(){
        var task = this.getTasks(),
            len = task.length,
            div = [], i, clone, content,
            fg = this.doc.createDocumentFragment(),
            base = this.doc.createElement('div');
            if(this.container){
                content = this.t.content.querySelector('div');
                content.innerHTML = '';
            } else {
                 content = this.doc.createElement('div');
                 content.className = 'icons';
                 this.setT();
            }
        for(i=0; i<len; i++){
            div[i] = this.doc.createElement('div');
            div[i].className = task[i];
            fg.appendChild(div[i]);
        }
        base.className = 'base';
        if(!this.chrome){
          var cloth = this.doc.createElement('div');
              cloth.className = 'cloth';
              base.appendChild(cloth);
              content.className += ' other';
        } else {
          if(!content.classList.contains('chrome'))
            content.className +=' chrome';
        }
        
        content.appendChild(base);
        content.appendChild(fg);
        //for safari & firefox
        if(!this.chrome){
          var hair = content.querySelector('.hair');
          var left = this.doc.createElement('div');
          var right = this.doc.createElement('div');
          left.className = 'left';
          right.className = 'right';
          hair.appendChild(left);
          hair.appendChild(right);
        }
        
        return content;
    }
    /**
     * @method pasteContent
     * @param {Element}
     * Append content and clone to shadow root 
     */
    MYAPP.TasksObj.prototype.pasteContent = function(c){
        
        var clone, i;
        this.t.content.appendChild(c);
        //for safari & firefox
        if(!this.chrome){
          var base = this.t.content.querySelectorAll('.base'),
              cloth = this.t.content.querySelectorAll('.cloth'),
              hair = this.t.content.querySelectorAll('.hair'),
              left = this.t.content.querySelectorAll('.left'),
              right = this.t.content.querySelectorAll('.right'),
              eyes = this.t.content.querySelectorAll('.sense'),
              small = this.t.content.querySelectorAll('.eyes-small');
          for(i in base){
            base[i].style.background = this.bg;
          }
          for(i in cloth){
            cloth[i].style.background = this.cloth;
          }
          for(i in hair){
            hair[i].style.background = this.hair;
          }
          for(i in left){
            left[i].style.background = this.hair;
          }
          for(i in right){
            right[i].style.background = this.hair;
          }
          for(i in eyes){
            eyes[i].style.background = this.eyes;
            eyes[i].style.boxShadow = this.eyes +" 40px 0";
          }
          for(i in small){
            small[i].style.boxShadow = this.eyes +" 42px 0";
          }
        }
        
        clone = document.importNode(this.t.content, true);
        this.el.style.width = '150px';
        this.el.style.height = '150px';
        this.root.appendChild(clone);
    }
    /**
     * @method getTasks
     * @return {Array}
     */
    MYAPP.TasksObj.prototype.getTasks = function(){
        return this.tasks;
    }
        /**
         * @method parseConfig
         * @param {Object}
         * @return {Array}
         * Sync all the change to this Array
         */
        var tasks;
        function parseConfig(input){
            tasks = [];
            for(var task in input){
                if(input[task] !== 'none'){
                    tasks.push(task);
                }
                var exist = tasks.indexOf(task);
                if(exist != -1){
                    if(typeof input[task] === 'object'){
                        for(var ts in input[task]){
                            tasks[exist] += ' '+ts+'-'+input[task][ts];
                        }
                    } else {
                        tasks[exist] += ' '+input[task];
                    }
                }
                
            }
            return tasks;
        }
        /**
         * @method customElement
         * Main
         */
        function customElement(){
        
          var doc = document._currentScript.ownerDocument,
              t = doc.querySelector('#sdtemplate'),
              proto = Object.create(HTMLElement.prototype),
              fg = doc.createDocumentFragment(),
              content = doc.createElement('div'),
              base = doc.createElement('div'),
              head = doc.createElement('head'),
              tk = '',
              isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
              /**
               * @method createdCallback
               * custom element callback
               */
              proto.createdCallback = function(){
                var attr = this.getAttribute('data-config'),
                    config = JSON.parse(attr), c,
                    newClass = "eyes-pos", that = this,
                    eyesColor = this.getAttribute('data-eyes'),
                    clothColor = this.getAttribute('data-cloth'),
                    bgColor = this.getAttribute('data-background'),
                    hairColor = this.getAttribute('data-hair');
                    if(config.hair.length === 'short'){
                        config.sense[newClass] = "down";
                    }
                    parseConfig(config);
                    tk = new MYAPP.TasksObj(isChrome, doc, tasks, t, that, false, bgColor, hairColor, eyesColor, clothColor);
                    c = tk.createFragment();
                    tk.pasteContent(c);
             }
             proto.attachedCallback = function(){
              if(isChrome){
                var el = this, that = this,
                    style = this.shadowRoot.querySelector('style'),
                    eyesColor = this.getAttribute('data-eyes'),
                    clothColor = this.getAttribute('data-cloth'),
                    bgColor = this.getAttribute('data-background'),
                    hairColor = this.getAttribute('data-hair');
                    
                    setTimeout(function() 
                      {
                        var sheet = style.sheet;
                        that.insertMultiple(sheet, ['.base { background: ' + bgColor + ' ; }',
                                  '.chrome .base::after { background: ' + clothColor + ' ; }',
                                  '.hair { background: ' + hairColor + ' ; }',
                                  '.chrome .hair::before { background: ' + hairColor + ' ; }',
                                  '.chrome .hair::after { background: ' + hairColor + ' ; }',
                                  '.sense { box-shadow: ' + eyesColor + ' 40px 0 ; }',
                                  '.sense { background: ' + eyesColor + ' ; }',
                                  '.eyes-small { box-shadow: ' + eyesColor + ' 42px 0 ; }'
                        ]);
                    });
              }
              /**
              * @method insertMultiple
              * For insert multiple CSS rules
              */
              proto.insertMultiple = function(sheet, arr){
                for(var i in arr){
                  sheet.insertRule(arr[i], sheet.cssRules.length);
                }
              }
             }
            MYAPP.selfClip = document.registerElement('self-clip', {prototype: proto});
          }
    customElement();
</script>