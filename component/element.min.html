<template id="sdtemplate">
  <style>
    .icons{
        width: 150px;
        height: 150px;
        display: inline-block;
        position: relative;
        padding-right: 2%;
        float: left;
    }
    .base{
        position: relative;
        width: 150px;
        height: 150px;
        background: #80B88C;
        border-radius: 50%;
        overflow: hidden;
        float: left;
    }
    .base:before{
        content: "";
        position: absolute;
        top: 10px;
        left: 35px;
        width: 80px;
        height: 90px;
        background: rgb(255, 201, 177);
        border-radius: 30px;
        z-index: 1;
    }
    .base:after{
        content: "";
        position: absolute;
        top: 100px;
        left: 40px;
        width: 70px;
        height: 50px;
        background: #A0DBDF;
        border-radius: 15px;
        z-index: 1;
    }
    .hair{
        position: absolute;
        width: 100px;
        height: 150px;
        background: rgb(51,49,49);
        top: -11px;
        left: 25px;
        border-radius: 45px;
    }
    .hair:before{
        content: "";
        position: absolute;
        top: 20px;
        left: 8px;
        height: 100px;
        background: rgb(51,49,49);
        -webkit-clip-path: polygon(6% 1%, 0% 50%, 100% 0%);
        clip-path: polygon(6% 1%, 0% 50%, 100% 0%);
        z-index: 1;
    }
    .hair:after{
        content: "";
        position: absolute;
        top: 20px;
        left: 70px;
        width: 26px;
        height: 49px;
        background: rgb(51,49,49);
        -webkit-clip-path: polygon(0 0, 80% 100%, 80% 0%);
        clip-path: polygon(0 0, 80% 100%, 80% 0%);
        z-index: 1;
    }
    .length-short{
        height: 120px;
    }
    .length-long{
        height: 150px;
    }
    .bang-left:before{
        width: 65px;
    }
    .bang-right:after{
        top: 19px;
        left: 16px;
        width: 76px;
        height: 42px;
        -webkit-clip-path: polygon(0 0, 100% 0%, 100% 100%);
        clip-path: polygon(0 0, 100% 0%, 100% 100%);
    }
    .bang-none:before, .bang-right:before{
        width: 25px;
    }
    .sense{
        position: relative;
        width: 15px;
        height: 25px;
        background: rgb(51,49,49);
        top: 49px;
        left: 48px;
        border-radius: 5px;
        z-index: 1;
        box-shadow: 40px 0 rgb(51,49,49);
    }
    .sense:before{
        content: "";
        position: absolute;
        width: 10px;
        height: 20px;
        background: rgb(255, 201, 177);
        right: 23px;
        top: 8px;
        border-radius: 5px;
        box-shadow: 80px 0 rgb(255, 201, 177);
    }
    .sense:after{
        content: "";
        position: absolute;
        border-radius: 0 0 30px 33px;
        background: #fff;
    }
    .eyes-pos-down{
        bottom: 105px;
    }
    .eyes-pos-left:after{
        left: 17px;
    }
    .mouth-joy:after{
        width: 15px;
        height: 15px;
        top: 30px;
        left: 20px;
    }
    .sense.mouth-shy:after{
        width: 5px;
        height: 10px;
        top: 30px;
        left: 24px;
    }
    .accessory.glass{
        width: 24px;
        height: 28px;
        border-radius: 3px;
        top: 46px;
        position: absolute;
        left: 43px;
        z-index: 1;
        background: rgba(124, 125, 124, 0.44);
        box-shadow: 40px 0 rgba(124, 125, 124, 0.44);
    }
    .accessory.earrings{
        width: 5px;
        height: 5px;
        background: #fff;
        position: absolute;
        left: 30px;
        top: 70px;
        z-index: 1;
        box-shadow: 84px 0 #fff;
    }
    .glass:before{
        content: "";
        width: 10px;
        border: 1px solid rgba(124, 125, 124, 0.44);
        position: absolute;
        right: 24px;
        bottom: 19px;
        box-shadow: 38px 3px rgba(124, 125, 124, 0.44), 76px 0 rgba(124, 125, 124, 0.44);
    }
    .eyes-small{
        width: 10px;
        height: 15px;
        bottom: 100px;
        left: 50px;
        box-shadow: 42px 0 rgb(51,49,49);
        bottom: 75px;
    }
    .eyes-small:after{
        left: 19px;
    }

    .eyes-small:before{
        box-shadow: 84px 0 rgb(255, 201, 177);
    }
  </style>
</template>
<script>
    var MYAPP = {};
    /**
     * @namespace MYAPP
     * @Object TasksObj
     * @constructor
     */
    MYAPP.TasksObj = function(doc, tasks, t, el, container){
        /**
         * @property doc
         * @type Element
         */
        this.doc = doc;
        /**
         * @property tasks
         * @type Array
         */
        this.tasks = tasks;
        /**
         * @property t
         * @type Element
         */
        this.t = t;
        /**
         * @property el
         * @type Element
         */
        this.el = el;
        /**
         * @property root
         * @type Element
         */
        this.root = el.createShadowRoot();
        /**
         * @property container
         * @type boolean
         */
        this.container = container;
    }
    /**
     * @method setT
     * Remove duplicate childNode
     */
    MYAPP.TasksObj.prototype.setT = function(){

        if(this.t.content && this.t.content.childNodes.length > 3){
            var len = this.t.content.childNodes.length;
                this.t.content.childNodes[len-1].remove();
        }
    }
    /**
     * @method createFragment
     * @return {Element}
     * Generate content includes all needed className 
     */
    MYAPP.TasksObj.prototype.createFragment = function(){
        var task = this.getTasks(),
            len = task.length,
            div = [], i, clone, content,
            fg = this.doc.createDocumentFragment(),
            base = this.doc.createElement('div');

            if(this.container){
                content = this.t.content.querySelector('div');
                content.innerHTML = '';
            } else {
                 content = this.doc.createElement('div');
                 content.className = 'icons';
                 this.setT();
            }

        for(i=0; i<len; i++){
            div[i] = this.doc.createElement('div');
            div[i].className = task[i];
            fg.appendChild(div[i]);
        }
        base.className = 'base';
        content.appendChild(base);
        content.appendChild(fg);
        return content;
    }
    /**
     * @method setRoot
     * @param {String}
     * Reset style
     */
    MYAPP.TasksObj.prototype.setRoot = function(r){
        this.root.textContent = r;
    }
    /**
     * @method setTasks
     * @param {Array}
     * Reset the className, re-create content and paste it to screen
     */
    MYAPP.TasksObj.prototype.setTasks = function(t){
        this.tasks = t;
        this.container = true;
        this.setRoot('');
        var c = this.createFragment();
        this.pasteContent(c, this.root);
    }
    /**
     * @method pasteContent
     * @param {Element}
     * Append content and clone to shadow root, get self-clip data-attr and corresponding change the css style 
     */
    MYAPP.TasksObj.prototype.pasteContent = function(c){
        var eyesColor = this.el.getAttribute('data-eyes'),
            clothColor = this.el.getAttribute('data-cloth'),
            bgColor = this.el.getAttribute('data-background'),
            hairColor = this.el.getAttribute('data-hair'),
            clone, node, i;

            this.t.content.appendChild(c);
            clone = document.importNode(this.t.content, true);
            this.el.style.width = '150px';
            this.el.style.height = '150px';
            this.root.appendChild(clone);

            node = this['root'].childNodes,
            style = node[1]['sheet'].cssRules;
            if(eyesColor || clothColor || bgColor || hairColor){
                for(i = 0; i<style.length;i++){
                    if(style[i].selectorText === '.base'){
                        style[i].style.background = bgColor;
                    }
                    if(style[i].selectorText === '.hair' || style[i].selectorText === '.hair::before'
                       || style[i].selectorText === '.hair::after' ){
                        style[i].style.background = hairColor;
                    }
                    if(style[i].selectorText === '.sense'){
                        style[i].style.background = eyesColor;
                        style[i].style.boxShadow = eyesColor+ " 40px 0px ";
                    }
                    if(style[i].selectorText === '.eyes-small'){
                        style[i].style.boxShadow = eyesColor+ " 42px 0px ";
                    }
                    if(style[i].selectorText === '.base::after'){
                        style[i].style.background = clothColor;
                    }
               }
            }
        
    }
    /**
     * @method getTasks
     * @return {Array}
     */
    MYAPP.TasksObj.prototype.getTasks = function(){
        return this.tasks;
    }

        /**
         * @method checkSupport
         * @return {Boolean}
         */
        function checkSupport(){
          return ('registerElement' in document);
        }

        /**
         * @method parseConfig
         * @param {Object}
         * @return {Array}
         * Sync all the change to this Array
         */
        var tasks;
        function parseConfig(input){
            tasks = [];
            for(var task in input){
                if(input[task] !== 'none'){
                    tasks.push(task);
                }
                var exist = tasks.indexOf(task);
                if(exist != -1){
                    if(typeof input[task] === 'object'){
                        for(var ts in input[task]){
                            tasks[exist] += ' '+ts+'-'+input[task][ts];
                        }
                    } else {
                        tasks[exist] += ' '+input[task];
                    }
                }
                
            }
            return tasks;
        }

        /**
         * @method customElement
         * Main
         */
        function customElement(){

        if(checkSupport()){
          var doc = document.currentScript.ownerDocument,
              t = doc.querySelector('#sdtemplate'),
              proto = Object.create(HTMLElement.prototype),
              fg = doc.createDocumentFragment(),
              content = doc.createElement('div'),
              base = doc.createElement('div'),
              tk = '';

              /**
               * @method createdCallback
               * custom element callback
               */
              proto.createdCallback = function(){
                var attr = this.getAttribute('data-config'),
                    bg = this.getAttribute('data-background'),
                    hair = this.getAttribute('data-hair'),
                    cloth = this.getAttribute('data-cloth'),
                    eyes = this.getAttribute('data-eyes'),
                    config = JSON.parse(attr), c,
                    newClass = "eyes-pos", that = this;

                    if(config.hair.length === 'short'){
                        config.sense[newClass] = "down";
                    }

                    parseConfig(config);
                    tk = new MYAPP.TasksObj(doc, tasks, t, that, false);
                    c = tk.createFragment();
                    tk.pasteContent(c);

             }
             /**
              * @method attributeChangedCallback
              * custom element has changed callback
              */
             proto.attributeChangedCallback = function(){
                 tk.setTasks(tasks);
             }
            MYAPP.selfClip = document.registerElement('self-clip', {prototype: proto});

        } else {
          alert("Sorry, your browser not supporting custom Elements without polyfill.");
        }
    }
    customElement();

</script>